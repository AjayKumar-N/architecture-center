# PCI DSS Guidance - Reference

## App Service Environment

An [App Service Environment (ASE)](https://docs.microsoft.com/en-us/azure/app-service-web/app-service-app-service-environment-intro) is a Premium service plan used for compliance reasons. Use of this plan allows for the following controls and configurations:
- Host inside a secured Virtual Network and Network security rules [Internal Load Balancing mode](https://docs.microsoft.com/en-us/azure/app-service-web/app-service-environment-with-internal-load-balancer) mode 3
- Disable [TLS 1.0](https://docs.microsoft.com/en-us/azure/app-service-web/app-service-app-service-environment-custom-settings) - a TLS protocol which is deprecated from a PCI DSS standpoint
- Change [TLS Cipher](https://docs.microsoft.com/en-us/azure/app-service-web/app-service-app-service-environment-custom-settings)
- Control [inbound traffic N/W ports](https://docs.microsoft.com/en-us/azure/app-service-web/app-service-app-service-environment-control-inbound-traffic)
- [WAF – Restrict Data](https://docs.microsoft.com/en-us/azure/app-service-web/app-service-app-service-environment-web-application-firewall)
- Allow [SQL DB traffic](https://docs.microsoft.com/en-us/azure/app-service-web/app-service-app-service-environment-network-architecture-overview)


## Operations Management Suite

[Operations Management Suite (OMS)]
(https://docs.microsoft.com/en-us/azure/operations-management-suite/) provides extensive logging of changes. Changes can be reviewed and verified for accuracy. 

- **Activity Logs:**  [Activity logs](https://docs.microsoft.com/en-us/azure/monitoring-and-diagnostics/monitoring-overview-activity-logs) provide insight into the operations that were performed on resources in your subscription.
- **Diagnostic Logs:**  [Diagnostic logs](https://docs.microsoft.com/en-us/azure/monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs) are all logs emitted by every resource. These logs include Windows event system logs, Azure Blob storage, tables, and queue logs.
- **Firewall Logs:**  The Application Gateway provides full diagnostic and access logs. Firewall logs are available for Application Gateway resources that have WAF enabled.
- **Log Archiving:**  All diagnostic logs are configured to write to a centralized and encrypted Azure storage account for archival with a defined retention period (2 days). Logs are then connected to Azure Log Analytics (OMS) for processing, storing, and dashboarding.


## Logging

The Contoso Webstore has extensive logging of all system, and user activity (including CHD logging):
- [Log Analytics] https://azure.microsoft.com/en-us/services/log-analytics/ is a service in Operations Management Suite (OMS) that helps you collect and analyze data generated by resources in your cloud and on-premises environments.
- Some OMS Solutions are pre-installed with this reference solution. For more information, see [PCI Guidance - Pre-Installed OMS Solutions](#pre-installed-oms-solutions).


## Pre-Installed OMS Solutions

The following OMS Solutions are pre-installed with this reference solution:
- [Activity Log Analytics](https://docs.microsoft.com/en-us/azure/monitoring-and-diagnostics/monitoring-overview-activity-logs)
- [Azure Networking Analytics](https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-azure-networking-analytics?toc=%2fazure%2foperations-management-suite%2ftoc.json)
- Azure SQL Analytics
- [Change Tracking](https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-change-tracking?toc=%2fazure%2foperations-management-suite%2ftoc.json)
- [Key Vault Analytics](https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-azure-key-vault?toc=%2fazure%2foperations-management-suite%2ftoc.json)
- [Service Map](https://docs.microsoft.com/en-us/azure/operations-management-suite/operations-management-suite-service-map)
- [Security and Audit](https://www.microsoft.com/en-us/cloud-platform/security-and-compliance) 
- [Antimalware](https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-malware?toc=%2fazure%2foperations-management-suite%2ftoc.json)
- [Update Management](https://docs.microsoft.com/en-us/azure/operations-management-suite/oms-solution-update-management)


## Azure SQL Database

A PaaS SQL Database instance is used to showcase database security measures:
- Enabled [AD Authentication and Authorization](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-aad-authentication)
- Enabled [auditing logging](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-auditing-get-started)
- Enabled [Transparent Data Encryption](https://docs.microsoft.com/en-us/sql/relational-databases/security/encryption/transparent-data-encryption-with-azure-sql-database)
- Enabled [SQL DB Firewall rules](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-firewall-configureallowing) (allowing for ASE worker pools and client IP management)
- Enabled [Threat Detection](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-threat-detection-get-started)
- Enabled [Always Encrypted columns](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-always-encrypted-azure-key-vault)
- Enabled [Dynamic Data Masking](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-dynamic-data-masking-get-startedusing) (using the post-deployment PowerShell script)


## Identity Management

The following technologies provide identity management capabilities in the Azure environment.
- [Azure Active Directory (Azure AD)](https://azure.microsoft.com/en-us/services/active-directory/) is the Microsoft's multi-tenant cloud-based directory and identity management service. All users for the solution were created in Azure Active Directory, including users accessing the SQL Database.
- Active Directory application
Authentication to the app is done through the Azure AD application and associated service principals.
Also, the SQL DB Column Encryption is conducted using the AD app. Refer to this sample from the Azure SQL DB team for more details.
    - https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-integrating-applications
    - https://docs.microsoft.com/en-us/azure/sql-database/sql-database-always-encrypted-azure-key-vault
    - https://github.com/Microsoft/azure-sql-security-sample
- [Azure Role-based Access Control (RBAC)](https://docs.microsoft.com/en-us/azure/active-directory/role-based-access-control-configure) enables precisely focused access management for Azure. Specific configurations exist for:
    - Subscription access is limited to the subscription administrator
    - Azure Key Vault access is restricted to all users
- [Azure Active Directory Identity Protection](https://docs.microsoft.com/en-us/azure/active-directory/active-directory-identityprotection) detects potential vulnerabilities affecting your organization’s identities, configures automated responses to detected suspicious actions related to your organization’s identities, and investigates suspicious incidents and takes appropriate action to resolve them.

## Malware Protection

[Azure Security Center](https://azure.microsoft.com/en-us/services/security-center/) provides a centralized view of the security state of all your Azure resources. At a glance, you can verify that the appropriate security controls are in place and configured correctly, and you can quickly identify any resources that require attention.  

[Microsoft Antimalware](https://docs.microsoft.com/en-us/azure/security/azure-security-antimalware) 
for Azure Cloud Services and Virtual Machines is real-time protection capability that helps identify and remove viruses, spyware, and other malicious software, with configurable alerts when known malicious or unwanted software attempts to install itself or run on your Azure systems.

**Optional Vulnerability Assessment**

Azure Advisor  https://docs.microsoft.com/en-us/azure/advisor/advisor-security-recommendations


## Mitigation of the Risk of Security Vulnerabilities

The reference solution reduces the risk of security vulnerabilities using an Application Gateway with WAF, and the OWASP ruleset enabled.  Additional capabilities include:
- [SSL Offload](https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-ssl-portal) 
- [Disable TLS v1.0 and v1.1] (https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-end-to-end-ssl-powershell )
- [Web application firewall] (https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-webapplicationfirewall-overview) - WAF mode 
- [Prevention mode] (https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-web-application-firewall-portal) with OWASP 3.0 ruleset
- [Diagnostics logging](https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-diagnostics)
- [Custom health probes](https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-create-gateway-portal)

Azure Security Center, and Azure security advisor provide additional protection and notifications. reputation system is provided by ASC
Azure Security Center https://azure.microsoft.com/en-us/services/security-center/
Azure Advisor  https://docs.microsoft.com/en-us/azure/advisor/advisor-security-recommendations


## Network Security Groups

Each of the network tiers has a dedicated network security group [NSG]:
- A DMZ network security group for firewall and Application Gateway WAF
- An NSG for management jumpbox/bastion host 
- An NSG for the app service environment

Each of the NSGs have specific ports and protocols opened for the secure and correct working of the solution. For more information, see [PCI Guidance - Network Security Groups](reference.md#network-security-groups).

Each of the NSGs have specific ports and protocols opened for the secure and
correct working of the solution. In addition, the following configurations are enabled for each NSG
- Enabled [diagnostic logs and events](https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-nsg-manage-log) are stored in storage account 
- Connected OMS Log Analytics to the [NSG's diagnostics](https://github.com/krnese/AzureDeploy/blob/master/AzureMgmt/AzureMonitor/nsgWithDiagnostics.json)
